name: Start and stop test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    env:
      KMS_KEY_ARN: ${{ vars.KMS_KEY_ARN }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      AWS_ROLE: ${{ vars.AWS_ROLE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE }}
          role-session-name: k8s-playground
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SOPS
        uses: nhedger/setup-sops@v2
        with:
          version: '3.7.3'

      - name: Replace KMS key's ARN placeholder
        run: |
          for file in k8s/terraform/secrets/*.yaml .github/secrets.env; do
            sed -i "s|\${KMS_KEY_ARN}|${{ env.KMS_KEY_ARN }}|g" "$file"
          done

      - name: Source secrets
        run: |
          sops -d .github/secrets.env > .github/secrets.decrypted.env
          cat .github/secrets.decrypted.env >> $GITHUB_ENV

      - name: Enable all disabled helm releases
        run: |
          sed -i 's/disabled: true/disabled: false/g' terraform/k8s/helm_releases.yaml

      - name: Start kind cluster
        run: |
          make start TERRAFORM_OPT='--auto-approve'

      - name: Run smoke tests
        run: |
          set -e
          declare -A tests=(
              ["Prometheus"]="http://localhost:30001"
              ["k8s-playground.gerardvm.tech"]="https://k8s-playground.gerardvm.tech:30443"
              ["flux.k8s-playground.gerardvm.tech"]="https://flux.k8s-playground.gerardvm.tech:30443"
              ["staging.k8s-playground.gerardvm.tech"]="https://staging.k8s-playground.gerardvm.tech:30443"
          )
          for service in "${!tests[@]}"; do
              echo "Testing $service..."
              success=false
              for i in {1..30}; do  # 30 attempts * 10s = 5 minutes
                  if curl -sSf --max-time 5 "${tests[$service]}"; then
                      echo "$service is up ✅"
                      success=true
                      break
                  else
                      echo "Attempt $i/30: $service not ready yet..."
                      sleep 10
                  fi
              done
              if [ "$success" = false ]; then
                  echo "$service test failed after 5 minutes ❌"
                  exit 1
              fi
          done

      - name: Stop kind cluster
        run: make stop TERRAFORM_OPT="--auto-approve"
